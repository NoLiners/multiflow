<%- layout('layout') -%>
    <div class="min-h-screen bg-gray-950 flex flex-col items-center justify-center p-4">

        <!-- Player Card -->
        <div class="w-full max-w-4xl">
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <a href="/dashboard"
                        class="w-8 h-8 flex items-center justify-center rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white transition-colors">
                        <i class="ti ti-arrow-left text-sm"></i>
                    </a>
                    <div>
                        <h1 class="text-lg font-bold text-white">Stream Player</h1>
                        <p class="text-xs text-gray-400">
                            <% if (streamType==='hls' ) { %>HLS (HTTP Live Streaming)<% } else { %>DASH (Dynamic
                                    Adaptive Streaming)<% } %>
                                        &nbsp;&bull;&nbsp; Key: <span class="text-blue-400 font-mono">
                                            <%= streamKey %>
                                        </span>
                        </p>
                    </div>
                </div>
                <!-- Switch type -->
                <div class="flex items-center gap-2">
                    <a href="/player?type=hls&key=<%= streamKey %>"
                        class="px-3 py-1.5 text-xs rounded-lg font-medium transition-colors <%= streamType === 'hls' ? 'bg-green-700 text-white' : 'bg-gray-800 text-gray-400 hover:text-white' %>">
                        HLS
                    </a>
                    <a href="/player?type=dash&key=<%= streamKey %>"
                        class="px-3 py-1.5 text-xs rounded-lg font-medium transition-colors <%= streamType === 'dash' ? 'bg-orange-700 text-white' : 'bg-gray-800 text-gray-400 hover:text-white' %>">
                        DASH
                    </a>
                </div>
            </div>

            <!-- Video Container -->
            <div class="bg-gray-900 rounded-xl overflow-hidden border border-gray-700 shadow-2xl">
                <div class="relative" style="padding-top: 56.25%;">
                    <video id="streamPlayer"
                        class="video-js vjs-default-skin vjs-big-play-centered absolute inset-0 w-full h-full" controls
                        autoplay muted preload="auto" data-setup='{}'>
                    </video>
                </div>
            </div>

            <!-- Source URL -->
            <div class="mt-4 bg-gray-800/50 rounded-lg p-3 border border-gray-700/40 flex items-center gap-3">
                <i class="ti ti-link text-gray-500 flex-shrink-0"></i>
                <code class="text-xs text-gray-300 font-mono flex-1 truncate" id="streamUrlDisplay"></code>
                <button id="copyBtn" onclick="copyStreamUrl()"
                    class="flex-shrink-0 flex items-center gap-1 px-3 py-1.5 bg-gray-700 hover:bg-blue-600 text-gray-300 hover:text-white text-xs rounded-lg transition-colors">
                    <i class="ti ti-copy text-xs"></i> Copy URL
                </button>
            </div>

            <!-- Tips -->
            <div class="mt-3 bg-blue-900/20 border border-blue-700/30 rounded-lg p-3">
                <div class="flex items-start gap-2">
                    <i class="ti ti-info-circle text-blue-400 text-sm mt-0.5 flex-shrink-0"></i>
                    <p class="text-xs text-gray-400">
                        Make sure you are actively streaming from OBS / FFmpeg / SRT to the server before playback. HLS
                        and DASH segments are generated in real-time.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Video.js -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <!-- DASH.js for DASH playback -->
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <!-- videojs-contrib-dash -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-dash/5.1.1/videojs-dash.min.js"></script>

    <script>
        (function () {
            const serverIp = '<%- serverIp %>';
            const streamKey = '<%- streamKey %>';
            const streamType = '<%- streamType %>';

            let streamUrl;
            if (streamType === 'dash') {
                streamUrl = `http://${serverIp}:8000/live/${streamKey}/index.mpd`;
            } else {
                streamUrl = `http://${serverIp}:8000/live/${streamKey}/index.m3u8`;
            }

            document.getElementById('streamUrlDisplay').textContent = streamUrl;

            const options = {
                autoplay: true,
                muted: true,
                controls: true,
                fluid: false,
                fill: true,
                liveui: true,
                sources: []
            };

            if (streamType === 'dash') {
                options.sources = [{
                    src: streamUrl,
                    type: 'application/dash+xml'
                }];
                options.techOrder = ['html5'];
            } else {
                options.sources = [{
                    src: streamUrl,
                    type: 'application/x-mpegURL'
                }];
            }

            const player = videojs('streamPlayer', options);
            player.ready(function () {
                console.log('[Player] Video.js initialized, type:', streamType, 'url:', streamUrl);
            });
            player.on('error', function () {
                console.warn('[Player] Playback error â€” stream may not be live yet.');
            });

            window.copyStreamUrl = function () {
                navigator.clipboard.writeText(streamUrl).then(() => {
                    const btn = document.getElementById('copyBtn');
                    btn.innerHTML = '<i class="ti ti-check text-xs"></i> Copied!';
                    btn.classList.add('bg-green-700', 'text-white');
                    setTimeout(() => {
                        btn.innerHTML = '<i class="ti ti-copy text-xs"></i> Copy URL';
                        btn.classList.remove('bg-green-700', 'text-white');
                    }, 1800);
                });
            };
        })();
    </script>